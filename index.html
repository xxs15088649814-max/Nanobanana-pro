<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xs的工具箱</title>
    <link rel="icon" href="kitty.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .custom-input { transition: all 0.2s; }
        .custom-input:focus { border-color: #6366f1; outline: none; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        .custom-input:read-only { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; border-color: #e5e7eb; }
        .dark .custom-input:read-only { background-color: #27272a; color: #71717a; border-color: #3f3f46; }
        select:disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed !important; }
        .dark select:disabled { background-color: #27272a; color: #52525b; }
        select { cursor: pointer !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #52525b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #71717a; }
        .active-btn { background-color: #a855f7; color: white; border-color: #a855f7; font-weight: bold; }
        #zoom-container { overflow: hidden; cursor: grab; position: relative; }
        #zoom-container:active { cursor: grabbing; }
        .compare-slider { position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; background: rgba(255, 255, 255, 0.8); z-index: 40; cursor: ew-resize; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .compare-handle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: black; box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        .task-checkbox { width: 16px; height: 16px; accent-color: #a855f7; cursor: pointer; }
        .resizer-x { width: 4px; cursor: col-resize; background: transparent; z-index: 50; }
        .resizer-y { height: 4px; cursor: row-resize; background: transparent; z-index: 50; }
        .no-select { user-select: none; }
        .dropdown-arrow { transition: transform 0.3s ease; }
        .dropdown-open .dropdown-arrow { transform: rotate(180deg); }
        .glow-effect { box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5); border-color: #6366f1 !important; color: #6366f1 !important; }
        .color-btn { width: 24px; height: 24px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: transform 0.1s; }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.active { border-color: #6366f1; box-shadow: 0 0 0 2px white, 0 0 0 4px #6366f1; }
        .tool-btn { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; color: #666; }
        .tool-btn.active { background-color: #e0e7ff; color: #6366f1; font-weight: bold; }
        .tool-btn:hover { background-color: #f3f4f6; }
        .dark .tool-btn { color: #aaa; }
        .dark .tool-btn.active { background-color: #3730a3; color: white; }
        .dark .tool-btn:hover { background-color: #27272a; }
        
        .group:hover .group-hover\:block { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .option-disabled { opacity: 0.5; pointer-events: none; cursor: not-allowed; background-color: #f3f4f6; }
        .dark .option-disabled { background-color: #27272a; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-gray-50 text-gray-800 dark:bg-[#09090b] dark:text-[#e4e4e7]" onclick="closeDropdownOnClickOutside(event)">

    <header class="h-14 border-b border-gray-200 dark:border-[#27272a] bg-white dark:bg-[#09090b] flex items-center justify-between px-4 shrink-0 z-50 transition-colors">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-white rounded-lg border border-gray-200 shadow-sm shrink-0 overflow-hidden">
                <img src="https://raw.githubusercontent.com/Vinsen0110/Nano2-Pro-Zz/main/nanobanana.jpg" class="w-full h-full object-cover" alt="Logo" onerror="this.src='kitty.png'">
            </div>
            <span class="font-bold text-lg tracking-tight text-gray-900 dark:text-gray-100">Nano Banana Pro</span>
        </div>
        
        <div class="flex items-center gap-3 text-sm">
            <div class="hidden md:flex items-center gap-2 px-3 py-1 bg-gray-100 dark:bg-[#18181b] border border-gray-200 dark:border-[#27272a] rounded-full text-[10px] font-mono text-gray-500 dark:text-gray-400 select-none mr-2" title="当前使用的API接口域名">
                <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                <span id="current-api-display">检测中...</span>
            </div>

            <div class="relative group z-50">
                <button class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white text-xs font-bold px-3 py-1.5 rounded transition shadow-sm flex items-center gap-1.5">
                    <i class="fa-solid fa-key"></i> 获取Key <i class="fa-solid fa-caret-down text-[10px] opacity-80"></i>
                </button>
                <div class="absolute top-full right-0 pt-2 w-32 hidden group-hover:block">
                    <div class="bg-white dark:bg-[#18181b] border border-gray-200 dark:border-[#27272a] rounded-xl shadow-xl overflow-hidden ring-1 ring-black/5">
                        <div class="py-1">
                            <a href="https://ai.t8star.cn/register?aff=XUPQ71902" target="_blank" class="flex items-center gap-2 px-4 py-2.5 text-xs font-bold text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-[#27272a] hover:text-purple-500 dark:hover:text-purple-400 transition">
                                <i class="fa-solid fa-spa text-pink-400"></i> 贞贞API
                            </a>
                            <div class="h-[1px] bg-gray-100 dark:bg-[#27272a] mx-2"></div>
                            <a href="https://api.bltcy.ai/register?aff=dlam79084" target="_blank" class="flex items-center gap-2 px-4 py-2.5 text-xs font-bold text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-[#27272a] hover:text-blue-500 dark:hover:text-blue-400 transition">
                                <i class="fa-solid fa-landmark text-blue-400"></i> 柏拉图API
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-[1px] h-4 bg-gray-300 dark:bg-gray-700 mx-1"></div>
            <button onclick="toggleTheme()" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 dark:hover:bg-[#18181b] dark:text-gray-400 transition"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
            <button onclick="openSettings()" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 dark:hover:bg-[#18181b] dark:text-gray-400 transition"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden" id="main-container">
        
        <aside id="left-panel" class="w-[360px] min-w-[280px] max-w-[600px] bg-white border-r border-gray-200 dark:bg-[#0c0c0e] dark:border-[#27272a] flex flex-col overflow-y-auto z-10 transition-colors">
            <div class="p-5 space-y-3">
                <div class="flex items-center justify-between relative z-50">
                    <div class="flex items-center gap-2 text-purple-500 font-bold text-sm uppercase tracking-wider">
                        <i class="fa-solid fa-sliders"></i> 生成设置
                    </div>
                    <div class="relative w-40" id="custom-model-dropdown">
                        <input type="hidden" id="model-input" value="nano-banana-2-4k">
                        <div onclick="toggleModelDropdown(event)" id="dropdown-trigger" class="w-full flex justify-between items-center bg-gray-100 dark:bg-[#18181b] border border-transparent dark:border-[#27272a] rounded-lg px-3 py-1.5 cursor-pointer transition-all hover:bg-gray-200 dark:hover:bg-[#27272a]">
                            <span id="current-model-text" class="text-xs font-bold font-mono text-gray-700 dark:text-gray-300">nano-banana-2-4K</span>
                            <i class="fa-solid fa-chevron-down text-[10px] text-gray-500 dropdown-arrow"></i>
                        </div>
                        <div id="dropdown-options" class="hidden absolute top-full right-0 mt-2 w-48 bg-white dark:bg-[#18181b] border border-gray-200 dark:border-[#27272a] rounded-xl shadow-xl overflow-hidden z-50 p-1">
                            <div onclick="selectModel('nano-banana-2-4k', 'nano-banana-2-4K')" class="model-option flex justify-between items-center px-3 py-2 rounded-lg cursor-pointer hover:bg-indigo-50 dark:hover:bg-[#27272a] group transition" data-val="nano-banana-2-4k">
                                <span class="text-xs font-bold text-gray-700 dark:text-gray-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-400">nano-banana-2-4K</span>
                                <i class="fa-solid fa-check text-indigo-500 text-xs opacity-100 check-icon"></i>
                            </div>
                            <div onclick="selectModel('nano-banana-hd', 'nano-banana-hd')" class="model-option flex justify-between items-center px-3 py-2 rounded-lg cursor-pointer hover:bg-indigo-50 dark:hover:bg-[#27272a] group transition" data-val="nano-banana-hd">
                                <span class="text-xs font-bold text-gray-700 dark:text-gray-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-400">nano-banana-hd</span>
                                <i class="fa-solid fa-check text-indigo-500 text-xs opacity-0 check-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-xs text-gray-500 font-bold uppercase">参考图片</label>
                        <button onclick="clearAllSlots()" class="text-[10px] text-red-500 hover:text-red-400 cursor-pointer ml-auto">清空全部</button>
                    </div>
                    <input type="file" id="slot-file-input" class="hidden" accept="image/*" onchange="handleSlotFile(event)">
                    <div id="slots-grid" class="grid grid-cols-3 gap-2 select-none"></div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs text-gray-500 font-bold uppercase">提示词</label>
                    <textarea id="prompt-input" class="w-full h-28 custom-input rounded-lg p-3 text-sm bg-gray-50 border-gray-300 text-gray-800 dark:bg-[#18181b] dark:border-[#27272a] dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-700 resize-none" placeholder="描述你的创意..."></textarea>
                    <p id="prompt-lock-msg" class="text-[10px] text-indigo-500 hidden flex items-center justify-between">
                        <span><i class="fa-solid fa-lock mr-1"></i> 检测到涂鸦，提示词已锁定。</span>
                        <span onclick="unlockPrompt()" class="cursor-pointer underline hover:text-indigo-400 font-bold ml-2">解锁</span>
                    </p>
                </div>

                <div class="space-y-2">
                    <label class="text-xs text-black dark:text-gray-200 font-bold uppercase">宽高比</label>
                    <div class="relative">
                        <select id="ratio-select" class="w-full custom-input rounded px-3 py-2 text-sm bg-gray-50 border-gray-300 text-black dark:bg-[#18181b] dark:border-[#27272a] dark:text-white appearance-none cursor-pointer">
                            <option value="1:1">1:1 (正方形)</option>
                            <option value="2:3">2:3 (竖屏)</option>
                            <option value="3:2">3:2 (横屏)</option>
                            <option value="3:4">3:4 (竖屏)</option>
                            <option value="4:3">4:3 (横屏)</option>
                            <option value="4:5">4:5 (竖屏)</option>
                            <option value="5:4">5:4 (横屏)</option>
                            <option value="9:16">9:16 (手机屏)</option>
                            <option value="16:9">16:9 (电脑屏)</option>
                            <option value="21:9">21:9 (超宽屏)</option>
                        </select>
                        <div class="absolute right-3 top-2.5 text-gray-500 pointer-events-none">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-xs text-gray-500 font-bold uppercase">数量</label>
                        <div class="flex gap-1">
                            <button onclick="setBatchSize(1)" class="batch-btn active-btn flex-1 py-2 text-xs rounded transition" data-val="1">1</button>
                            <button onclick="setBatchSize(2)" class="batch-btn inactive-btn bg-gray-100 border-gray-300 text-gray-500 dark:bg-[#18181b] dark:border-[#27272a] dark:text-gray-400 flex-1 py-2 text-xs rounded transition" data-val="2">2</button>
                            <button onclick="setBatchSize(3)" class="batch-btn inactive-btn bg-gray-100 border-gray-300 text-gray-500 dark:bg-[#18181b] dark:border-[#27272a] dark:text-gray-400 flex-1 py-2 text-xs rounded transition" data-val="3">3</button>
                            <button onclick="setBatchSize(4)" class="batch-btn inactive-btn bg-gray-100 border-gray-300 text-gray-500 dark:bg-[#18181b] dark:border-[#27272a] dark:text-gray-400 flex-1 py-2 text-xs rounded transition" data-val="4">4</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs text-black dark:text-gray-200 font-bold uppercase">分辨率</label>
                        <select id="size-select" class="w-full custom-input rounded px-3 py-2 text-sm bg-gray-50 border-gray-300 text-black dark:bg-[#18181b] dark:border-[#27272a] dark:text-white cursor-pointer">
                            <option value="4K">4K</option>
                            <option value="2K">2K</option>
                            <option value="1K">1K</option>
                        </select>
                    </div>
                </div>
                <div class="pt-4 pb-10">
                    <button onclick="submitTask()" id="generate-btn" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 hover:opacity-90 text-white font-bold py-3.5 rounded-lg transition transform active:scale-[0.98] flex items-center justify-center gap-2 shadow-lg shadow-purple-500/20">
                        <span class="text-base">✨ 立即生成</span><i id="loading-icon" class="fa-solid fa-circle-notch fa-spin hidden"></i>
                    </button>
                </div>
            </div>
        </aside>

        <div id="resizer-sidebar" class="resizer-x bg-gray-200 dark:bg-[#1f1f22]"></div>

        <main class="flex-1 flex flex-col min-w-0 bg-gray-100 dark:bg-black transition-colors" id="right-panel">
            <div class="h-12 border-b border-gray-200 dark:border-[#27272a] bg-white dark:bg-[#0c0c0e] flex items-center justify-between px-4 shrink-0 z-20 transition-colors">
                <button onclick="importCurrentImage()" class="text-xs text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white flex items-center gap-2 transition" title="将当前图作为参考图">
                    <i class="fa-solid fa-arrow-left"></i> 导入
                </button>
                <div class="flex items-center gap-4">
                    <button onclick="downloadCurrentImage()" class="text-xs text-gray-500 dark:text-gray-400 hover:text-purple-500 dark:hover:text-purple-500 flex items-center gap-2 transition">下载 JPG <i class="fa-solid fa-download"></i></button>
                </div>
            </div>

            <div class="flex-1 relative flex flex-col overflow-hidden select-none bg-gray-200 dark:bg-black transition-colors" id="preview-area">
                <div class="absolute top-4 left-4 z-30 flex items-center gap-4 bg-white/80 dark:bg-[#18181b]/80 backdrop-blur rounded-lg px-3 py-1.5 border border-gray-200 dark:border-[#27272a] shadow-sm">
                    <span class="text-xs font-bold text-gray-800 dark:text-white">Preview</span>
                    <div class="w-[1px] h-3 bg-gray-300 dark:bg-gray-600"></div>
                    <span class="text-[10px] text-gray-500 dark:text-gray-400">滚轮缩放 / 拖拽 / 双击复位</span>
                    <div class="w-[1px] h-3 bg-gray-300 dark:bg-gray-600"></div>
                    <button onclick="clearMainPreview()" class="text-gray-400 hover:text-red-500 text-xs"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div id="time-badge" class="absolute top-4 right-4 z-30 hidden bg-purple-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow-lg">
                    <i class="fa-solid fa-stopwatch mr-1"></i><span id="time-val">0s</span>
                </div>
                <div id="zoom-container" class="w-full h-full flex items-center justify-center relative">
                    <div id="empty-placeholder" class="text-center absolute pointer-events-none">
                        <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-white dark:bg-[#111] border border-gray-200 dark:border-[#222] flex items-center justify-center"><i class="fa-solid fa-image text-3xl text-gray-300 dark:text-[#333]"></i></div>
                        <p class="text-gray-500 dark:text-gray-600 text-sm">图片预览区</p>
                    </div>
                    <div id="img-wrapper" class="relative hidden shadow-2xl transition-transform duration-100 ease-out origin-center">
                        <img id="main-image" class="max-h-[85vh] max-w-[85vw] object-contain block" draggable="false">
                        <div id="compare-overlay" class="absolute inset-0 hidden">
                            <img id="ref-image" class="w-full h-full object-contain block" draggable="false">
                        </div>
                        <div id="slider-handle" class="compare-slider hidden">
                            <div class="compare-handle"><i class="fa-solid fa-left-right text-xs"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="resizer-tasklist" class="resizer-y bg-gray-200 dark:bg-[#1f1f22]"></div>

            <div id="task-panel" class="h-[220px] min-h-[150px] max-h-[600px] bg-white dark:bg-[#0c0c0e] flex flex-col shrink-0 z-20 transition-colors">
                <div class="px-4 py-2 flex items-center justify-between bg-gray-50 dark:bg-[#121214] border-b border-gray-100 dark:border-none">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="select-all" class="task-checkbox" onchange="toggleSelectAll()">
                        <span id="task-list-title" class="text-xs font-bold text-gray-600 dark:text-gray-300 transition-colors">任务列表</span>
                    </div>
                    <div id="batch-actions" class="hidden flex gap-2">
                        <button onclick="batchDownload()" class="text-[10px] bg-purple-500/20 text-purple-500 hover:bg-purple-500 hover:text-white px-2 py-1 rounded transition border border-purple-500/30">下载选中</button>
                        <button onclick="batchDelete()" class="text-[10px] bg-red-500/20 text-red-500 hover:bg-red-500 hover:text-white px-2 py-1 rounded transition border border-red-500/30">删除选中</button>
                    </div>
                </div>
                <div id="history-list" class="flex-1 p-4 overflow-x-auto flex gap-4 items-center">
                    <div id="history-empty" class="text-xs text-gray-400 w-full text-center select-none">暂无历史任务</div>
                </div>
            </div>
        </main>
    </div>

    <div id="editor-modal" class="fixed inset-0 bg-black/90 z-[100] hidden flex flex-col items-center justify-center">
        <div class="absolute top-6 flex gap-4 bg-white dark:bg-[#18181b] p-2 rounded-full shadow-2xl border border-gray-200 dark:border-[#27272a] z-50">
            <div class="flex gap-2 border-r border-gray-200 dark:border-gray-700 pr-4 mr-2">
                <div class="color-btn bg-red-500 active" onclick="setDrawColor('#ef4444', this)"></div>
                <div class="color-btn bg-amber-500" onclick="setDrawColor('#f59e0b', this)"></div>
                <div class="color-btn bg-emerald-500" onclick="setDrawColor('#10b981', this)"></div>
                <div class="color-btn bg-blue-500" onclick="setDrawColor('#3b82f6', this)"></div>
                <div class="color-btn bg-white" onclick="setDrawColor('#ffffff', this)"></div>
            </div>
            <div class="flex gap-2 items-center">
                <div class="tool-btn active" id="tool-brush" onclick="setTool('brush')" title="画笔"><i class="fa-solid fa-paintbrush"></i></div>
                <div class="tool-btn" id="tool-text" onclick="setTool('text')" title="文字"><i class="fa-solid fa-font"></i></div>
                <div class="tool-btn" id="tool-move" onclick="setTool('move')" title="移动文字"><i class="fa-solid fa-arrows-up-down-left-right"></i></div>
                <div class="w-[1px] h-4 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                <div class="tool-btn hover:text-indigo-500" onclick="undo()" title="撤回上一步"><i class="fa-solid fa-rotate-left"></i></div>
            </div>
        </div>
        <div class="absolute bottom-10 flex gap-4 z-50">
            <button onclick="cancelEdit()" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-full text-sm font-bold shadow-lg transition">取消</button>
            <button onclick="saveEdit()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full text-sm font-bold shadow-lg shadow-indigo-500/30 transition">确认修改</button>
        </div>
        <div id="canvas-wrapper" class="relative flex items-center justify-center bg-[#111] rounded-xl overflow-hidden border border-gray-800" style="max-width: 90vw; max-height: 80vh;">
            <canvas id="paint-canvas" class="cursor-crosshair shadow-2xl"></canvas>
            <input type="text" id="text-tool-input" class="absolute hidden bg-transparent border border-dashed border-white text-white text-lg p-1 outline-none font-bold" placeholder="输入文字..." draggable="false">
        </div>
    </div>

    <div id="lightbox-modal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center cursor-pointer" onclick="closeLightbox()">
        <img id="lightbox-img" class="max-w-[95%] max-h-[95%] object-contain rounded shadow-2xl" src="">
        <div class="absolute bottom-10 text-white text-sm bg-black/50 px-4 py-1 rounded-full">点击任意位置关闭</div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-[#18181b] p-6 rounded-xl w-96 shadow-2xl border border-gray-200 dark:border-[#27272a]">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold dark:text-white flex items-center gap-2"><i class="fa-solid fa-gear text-purple-500"></i> API 设置</h3><button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600 dark:hover:text-white"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">API 网站地址 (自动追加 /v1/images/edits)</label>
                    <input type="text" id="modal-api-url" class="w-full bg-gray-50 dark:bg-[#0c0c0e] border border-gray-300 dark:border-[#27272a] rounded p-3 text-sm text-gray-800 dark:text-gray-200 outline-none focus:border-purple-500" placeholder="https://api.bltcy.ai">
                    
                    <div class="flex gap-2 mt-2">
                        <button onclick="fillApiUrl('https://ai.t8star.cn')" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-pink-50 dark:bg-pink-900/20 border border-pink-200 dark:border-pink-800 text-xs font-bold text-pink-600 dark:text-pink-400 hover:bg-pink-100 dark:hover:bg-pink-900/40 transition cursor-pointer">
                            <i class="fa-solid fa-spa"></i> 贞贞: ai.t8star.cn
                        </button>
                        <button onclick="fillApiUrl('https://api.bltcy.ai')" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 text-xs font-bold text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition cursor-pointer">
                            <i class="fa-solid fa-landmark"></i> 柏拉图: api.bltcy.ai
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">API Key</label>
                    <input type="password" id="modal-api-key" class="w-full bg-gray-50 dark:bg-[#0c0c0e] border border-gray-300 dark:border-[#27272a] rounded p-3 text-sm text-gray-800 dark:text-gray-200 outline-none focus:border-purple-500" placeholder="sk-xxxxxxxx">
                    <p class="text-[10px] text-gray-400 mt-1">Key 和 URL 配置保存在本地。</p>
                </div>
                <button onclick="saveSettings()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 rounded transition">保存配置</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_API_URL = "https://api.bltcy.ai"; 
        const MAX_SLOTS = 9;
        let imageSlots = new Array(MAX_SLOTS).fill(null);
        let currentActiveSlot = -1; 
        let batchSize = 1;
        let currentMainImageUrl = ""; 
        let scale = 1, panning = false, pointX = 0, pointY = 0, startX = 0, startY = 0;
        let originalRefImage = null; 
        
        let historyData = [];

        const FIXED_PROMPT = "按照图片上的标记对图片进行修改，修改完成后将标记去掉，包括文字和画线";
        let isDrawing = false;
        let ctx = null;
        let currentColor = '#ef4444';
        let currentTool = 'brush'; 
        let editTargetIndex = -1;
        let canvas = document.getElementById('paint-canvas');
        let drawActions = [];
        let currentPath = null;
        let baseImage = null; 
        let isDraggingText = false;
        let draggingActionIndex = -1;
        let dragStartOffset = { x: 0, y: 0 };

        window.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('nano_api_key');
            if (savedKey) document.getElementById('modal-api-key').value = savedKey; 
            
            const savedUrl = localStorage.getItem('nano_api_url');
            document.getElementById('modal-api-url').value = savedUrl || DEFAULT_API_URL;
            
            updateApiDisplay(savedUrl || DEFAULT_API_URL);

            if (!savedKey) openSettings();

            const savedTheme = localStorage.getItem('nano_theme');
            const icon = document.getElementById('theme-icon');
            if (savedTheme === 'light') { document.documentElement.classList.remove('dark'); icon.className = 'fa-solid fa-sun text-purple-500'; }
            else { document.documentElement.classList.add('dark'); icon.className = 'fa-solid fa-moon'; }
            
            ctx = canvas.getContext('2d');
            document.getElementById('text-tool-input').addEventListener('keydown', (e) => {
                if(e.key === 'Enter') finalizeText();
            });
            renderSlots();
            
            const savedHistory = localStorage.getItem('nano_history_data');
            if (savedHistory) {
                try {
                    historyData = JSON.parse(savedHistory);
                    for (let i = historyData.length - 1; i >= 0; i--) {
                        renderHistoryItem(historyData[i].url, historyData[i].prompt, historyData[i].duration);
                    }
                } catch (e) { console.error("History Load Error", e); }
            }

            // === 页面加载时检查模型限制 ===
            updateModelRestrictions();
        });

        function fillApiUrl(url) {
            document.getElementById('modal-api-url').value = url;
            const input = document.getElementById('modal-api-url');
            input.classList.add('ring-2', 'ring-purple-500');
            setTimeout(() => input.classList.remove('ring-2', 'ring-purple-500'), 200);
        }

        function updateApiDisplay(url) {
            try {
                const hostname = new URL(url).hostname;
                document.getElementById('current-api-display').innerText = "当前: " + hostname;
            } catch (e) {
                document.getElementById('current-api-display').innerText = "当前: Custom";
            }
        }

        // === 模型限制逻辑 ===
        function updateModelRestrictions() {
            const currentUrl = localStorage.getItem('nano_api_url') || DEFAULT_API_URL;
            const isPlato = currentUrl.includes('bltcy.ai');
            
            const hdOption = document.querySelector('.model-option[data-val="nano-banana-hd"]');
            if (!hdOption) return;

            if (isPlato) {
                hdOption.classList.add('option-disabled');
                const currentModel = document.getElementById('model-input').value;
                if (currentModel === 'nano-banana-hd') {
                    selectModel('nano-banana-2-4k', 'nano-banana-2-4K');
                }
            } else {
                hdOption.classList.remove('option-disabled');
            }
        }

        function saveHistoryToLocal() {
            if (historyData.length > 50) historyData = historyData.slice(0, 50);
            localStorage.setItem('nano_history_data', JSON.stringify(historyData));
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if(baseImage) { ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height); }
            drawActions.forEach(action => {
                ctx.fillStyle = action.color;
                ctx.strokeStyle = action.color;
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                if(action.type === 'path') {
                    ctx.beginPath();
                    if(action.points.length > 0) {
                        ctx.moveTo(action.points[0].x, action.points[0].y);
                        for(let i=1; i<action.points.length; i++) { ctx.lineTo(action.points[i].x, action.points[i].y); }
                    }
                    ctx.stroke();
                } else if(action.type === 'text') {
                    ctx.font = "bold 24px Arial";
                    ctx.fillText(action.text, action.x, action.y);
                }
            });
        }
        function openEditor(index, event) {
            if(event) event.stopPropagation();
            const file = imageSlots[index];
            if(!file) return;
            editTargetIndex = index;
            drawActions = [];
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    baseImage = img;
                    const wrapper = document.getElementById('canvas-wrapper');
                    const maxW = window.innerWidth * 0.9;
                    const maxH = window.innerHeight * 0.8;
                    let w = img.width, h = img.height;
                    const ratio = Math.min(maxW / w, maxH / h);
                    canvas.width = w * ratio;
                    canvas.height = h * ratio;
                    wrapper.style.width = canvas.width + 'px';
                    wrapper.style.height = canvas.height + 'px';
                    redrawCanvas();
                    document.getElementById('editor-modal').classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        function undo() { if(drawActions.length > 0) { drawActions.pop(); redrawCanvas(); } }
        function cancelEdit() { document.getElementById('editor-modal').classList.add('hidden'); document.getElementById('text-tool-input').classList.add('hidden'); }
        function saveEdit() {
            const input = document.getElementById('text-tool-input');
            if (!input.classList.contains('hidden')) finalizeText();
            redrawCanvas();
            canvas.toBlob((blob) => {
                const newFile = new File([blob], `doodle_${Date.now()}.png`, { type: 'image/png' });
                newFile.isDoodled = true;
                imageSlots[editTargetIndex] = newFile;
                renderSlots();
                updatePromptLockState(); 
                cancelEdit();
            });
        }
        function setDrawColor(color, btn) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const input = document.getElementById('text-tool-input');
            if(!input.classList.contains('hidden')) { input.style.color = color; input.style.borderColor = color; }
        }
        function setTool(tool) {
            if(currentTool === 'text' && tool !== 'text') { const input = document.getElementById('text-tool-input'); if(!input.classList.contains('hidden')) finalizeText(); }
            currentTool = tool;
            document.getElementById('tool-brush').classList.toggle('active', tool === 'brush');
            document.getElementById('tool-text').classList.toggle('active', tool === 'text');
            document.getElementById('tool-move').classList.toggle('active', tool === 'move');
            if(tool === 'move') canvas.style.cursor = 'move';
            else if(tool === 'text') canvas.style.cursor = 'text';
            else canvas.style.cursor = 'crosshair';
        }
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            if (currentTool === 'brush') {
                isDrawing = true;
                currentPath = { type: 'path', color: currentColor, points: [{x, y}] };
                drawActions.push(currentPath);
                redrawCanvas();
            } else if (currentTool === 'text') {
                handleTextClick(e);
            } else if (currentTool === 'move') {
                for (let i = drawActions.length - 1; i >= 0; i--) {
                    const act = drawActions[i];
                    if (act.type === 'text') {
                        ctx.font = "bold 24px Arial";
                        const w = ctx.measureText(act.text).width;
                        const h = 24; 
                        if (x >= act.x && x <= act.x + w && y >= act.y - h && y <= act.y + 10) {
                            isDraggingText = true;
                            draggingActionIndex = i;
                            dragStartOffset = { x: x - act.x, y: y - act.y };
                            return;
                        }
                    }
                }
            }
        });
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            if (isDrawing && currentTool === 'brush') { currentPath.points.push({x, y}); redrawCanvas(); } 
            else if (isDraggingText && currentTool === 'move') { const act = drawActions[draggingActionIndex]; act.x = x - dragStartOffset.x; act.y = y - dragStartOffset.y; redrawCanvas(); }
        });
        window.addEventListener('mouseup', () => { isDrawing = false; isDraggingText = false; draggingActionIndex = -1; });
        function handleTextClick(e) {
            const input = document.getElementById('text-tool-input');
            const rect = document.getElementById('canvas-wrapper').getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            if (!input.classList.contains('hidden')) finalizeText();
            input.value = ""; input.style.left = x + 'px'; input.style.top = y + 'px'; input.style.color = currentColor; input.style.borderColor = currentColor;
            input.classList.remove('hidden'); setTimeout(() => input.focus(), 10);
        }
        function finalizeText() {
            const input = document.getElementById('text-tool-input');
            if (input.classList.contains('hidden') || !input.value.trim()) { input.classList.add('hidden'); return; }
            const x = parseFloat(input.style.left);
            const y = parseFloat(input.style.top) + 22;
            drawActions.push({ type: 'text', text: input.value, color: currentColor, x: x, y: y });
            input.classList.add('hidden'); redrawCanvas();
        }

        let manualUnlock = false;
        function updatePromptLockState() {
            const currentModel = document.getElementById('model-input').value;
            const hasDoodle = imageSlots.some(file => file && file.isDoodled);
            const promptBox = document.getElementById('prompt-input');
            const lockMsg = document.getElementById('prompt-lock-msg');
            if (!hasDoodle) manualUnlock = false;
            if (currentModel === 'nano-banana-2-4k' && hasDoodle && !manualUnlock) {
                promptBox.value = FIXED_PROMPT; promptBox.readOnly = true; lockMsg.classList.remove('hidden');
            } else { promptBox.readOnly = false; lockMsg.classList.add('hidden'); }
        }
        function unlockPrompt() { manualUnlock = true; updatePromptLockState(); }

        function toggleModelDropdown(event) {
            if(event) event.stopPropagation();
            const container = document.getElementById('custom-model-dropdown');
            const options = document.getElementById('dropdown-options');
            const trigger = document.getElementById('dropdown-trigger');
            container.classList.toggle('dropdown-open'); options.classList.toggle('hidden');
            if (container.classList.contains('dropdown-open')) { trigger.classList.add('glow-effect'); trigger.classList.remove('bg-gray-100', 'dark:bg-[#18181b]'); } 
            else { trigger.classList.remove('glow-effect'); trigger.classList.add('bg-gray-100', 'dark:bg-[#18181b]'); }
        }
        function selectModel(val, text) {
            document.getElementById('model-input').value = val;
            document.getElementById('current-model-text').innerText = text;
            const sizeSelect = document.getElementById('size-select');
            if (val === 'nano-banana-hd') { sizeSelect.value = '2K'; sizeSelect.disabled = true; } else { sizeSelect.disabled = false; }
            document.querySelectorAll('.model-option').forEach(opt => {
                const check = opt.querySelector('.check-icon');
                if(opt.dataset.val === val) { check.classList.remove('opacity-0'); check.classList.add('opacity-100'); opt.classList.add('bg-indigo-50', 'dark:bg-[#27272a]'); } 
                else { check.classList.add('opacity-0'); check.classList.remove('opacity-100'); opt.classList.remove('bg-indigo-50', 'dark:bg-[#27272a]'); }
            });
            toggleModelDropdown(); renderSlots(); updatePromptLockState();
        }
        function closeDropdownOnClickOutside(event) {
            const container = document.getElementById('custom-model-dropdown');
            const options = document.getElementById('dropdown-options'); const trigger = document.getElementById('dropdown-trigger');
            if (container && !container.contains(event.target)) { container.classList.remove('dropdown-open'); options.classList.add('hidden'); trigger.classList.remove('glow-effect'); trigger.classList.add('bg-gray-100', 'dark:bg-[#18181b]'); }
        }
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if (html.classList.contains('dark')) { html.classList.remove('dark'); icon.className = 'fa-solid fa-sun text-purple-500'; localStorage.setItem('nano_theme', 'light'); }
            else { html.classList.add('dark'); icon.className = 'fa-solid fa-moon'; localStorage.setItem('nano_theme', 'dark'); }
        }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        
        function saveSettings() { 
            const key = document.getElementById('modal-api-key').value.trim(); 
            const url = document.getElementById('modal-api-url').value.trim();
            if (key) { 
                localStorage.setItem('nano_api_key', key); 
                localStorage.setItem('nano_api_url', url || DEFAULT_API_URL);
                updateApiDisplay(url || DEFAULT_API_URL); 
                updateModelRestrictions();
                closeSettings(); 
            } else { 
                alert("请输入API Key"); 
            } 
        }

        const leftPanel = document.getElementById('left-panel'), resizerSidebar = document.getElementById('resizer-sidebar');
        const taskPanel = document.getElementById('task-panel'), resizerTasklist = document.getElementById('resizer-tasklist');
        resizerSidebar.addEventListener('mousedown', (e) => { e.preventDefault(); document.body.classList.add('no-select'); document.addEventListener('mousemove', resizeSidebar); document.addEventListener('mouseup', stopResizeSidebar); });
        function resizeSidebar(e) { const w = e.clientX; if (w > 280 && w < 600) leftPanel.style.width = w + 'px'; }
        function stopResizeSidebar() { document.body.classList.remove('no-select'); document.removeEventListener('mousemove', resizeSidebar); document.removeEventListener('mouseup', stopResizeSidebar); }
        resizerTasklist.addEventListener('mousedown', (e) => { e.preventDefault(); document.body.classList.add('no-select'); document.addEventListener('mousemove', resizeTasklist); document.addEventListener('mouseup', stopResizeTasklist); });
        function resizeTasklist(e) { const h = window.innerHeight - e.clientY; if (h > 120 && h < 600) taskPanel.style.height = h + 'px'; }
        function stopResizeTasklist() { document.body.classList.remove('no-select'); document.removeEventListener('mousemove', resizeTasklist); document.removeEventListener('mouseup', stopResizeTasklist); }

        function renderSlots() {
            const grid = document.getElementById('slots-grid');
            const currentModel = document.getElementById('model-input').value; const canDoodle = (currentModel === 'nano-banana-2-4k');
            grid.innerHTML = '';
            imageSlots.forEach((file, index) => {
                const slotNum = index + 1; const div = document.createElement('div');
                div.className = `relative w-full aspect-[4/3] rounded-lg border-2 border-dashed transition-all cursor-pointer overflow-hidden flex flex-col items-center justify-center group ${file ? 'border-transparent bg-gray-900' : 'border-gray-300 dark:border-[#27272a] hover:border-purple-500 dark:hover:border-purple-500 bg-gray-50 dark:bg-[#18181b] hover:bg-purple-50 dark:hover:bg-[#1f1f22]'}`;
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        let doodleBadge = file.isDoodled ? `<div class="absolute bottom-1 right-1 text-xs text-indigo-400 font-bold z-10"><i class="fa-solid fa-pen-nib"></i></div>` : "";
                        let editBtn = canDoodle ? `<div onclick="openEditor(${index}, event)" class="absolute bottom-1 left-1 w-5 h-5 bg-indigo-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-sm z-20 hover:scale-110 hover:bg-indigo-400" title="涂鸦编辑"><i class="fa-solid fa-paintbrush text-[10px]"></i></div>` : "";
                        div.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover pointer-events-none"><div class="absolute top-1 left-1 bg-black/60 text-white text-[9px] font-bold px-1.5 rounded backdrop-blur-sm z-10">图 ${slotNum}</div>${editBtn} ${doodleBadge}<div onclick="clearSlot(${index}, event)" class="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-sm z-20 hover:scale-110"><i class="fa-solid fa-xmark text-[10px]"></i></div><div onclick="viewOriginal('${e.target.result}')" class="absolute inset-0 z-0"></div>`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    div.onclick = () => triggerSlotUpload(index);
                    div.innerHTML = `<i class="fa-solid fa-plus text-gray-300 dark:text-gray-600 text-lg mb-1 group-hover:text-purple-500 transition"></i><span class="text-[10px] text-gray-400 dark:text-gray-500 font-mono group-hover:text-purple-500 transition">图片 ${slotNum}</span>`;
                }
                grid.appendChild(div);
            });
        }
        function triggerSlotUpload(index) { currentActiveSlot = index; const input = document.getElementById('slot-file-input'); input.value = ''; input.click(); }
        function handleSlotFile(event) { const file = event.target.files[0]; if (!file) return; imageSlots[currentActiveSlot] = file; renderSlots(); updatePromptLockState(); }
        function clearSlot(index, event) { if(event) event.stopPropagation(); imageSlots[index] = null; renderSlots(); updatePromptLockState(); }
        function clearAllSlots() { imageSlots = new Array(MAX_SLOTS).fill(null); renderSlots(); updatePromptLockState(); }

        const zoomContainer = document.getElementById('zoom-container'), imgWrapper = document.getElementById('img-wrapper'), sliderHandle = document.getElementById('slider-handle'), compareOverlay = document.getElementById('compare-overlay');
        function updateTransform() { imgWrapper.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }
        function resetZoom() { scale = 1; pointX = 0; pointY = 0; updateTransform(); }
        zoomContainer.addEventListener('wheel', (e) => { if (imgWrapper.classList.contains('hidden')) return; e.preventDefault(); const delta = -e.deltaY; (delta > 0) ? (scale *= 1.1) : (scale /= 1.1); if (scale < 0.5) scale = 0.5; if (scale > 5) scale = 5; updateTransform(); });
        zoomContainer.addEventListener('mousedown', (e) => { if (e.target.closest('#slider-handle')) { isSliding = true; e.preventDefault(); return; } if (imgWrapper.classList.contains('hidden')) return; e.preventDefault(); startX = e.clientX - pointX; startY = e.clientY - pointY; panning = true; });
        window.addEventListener('mouseup', () => { panning = false; isSliding = false; });
        zoomContainer.addEventListener('mousemove', (e) => { if (isSliding) { const rect = imgWrapper.getBoundingClientRect(); let x = e.clientX - rect.left; if (x < 0) x = 0; if (x > rect.width) x = rect.width; const percentage = (x / rect.width) * 100; sliderHandle.style.left = percentage + '%'; compareOverlay.style.clipPath = `inset(0 ${100 - percentage}% 0 0)`; return; } if (!panning) return; e.preventDefault(); pointX = e.clientX - startX; pointY = e.clientY - startY; updateTransform(); });
        zoomContainer.addEventListener('dblclick', resetZoom);
        function setBatchSize(num) { batchSize = num; document.querySelectorAll('.batch-btn').forEach(btn => { if(parseInt(btn.dataset.val) === num) btn.className = "batch-btn active-btn flex-1 py-2 text-xs rounded transition"; else btn.className = "batch-btn inactive-btn bg-gray-100 border-gray-300 text-gray-500 dark:bg-[#18181b] dark:border-[#27272a] dark:text-gray-400 flex-1 py-2 text-xs rounded transition"; }); }

        // === 修改：并发请求逻辑修复批量生成问题 ===
        async function submitTask() {
            const apiKey = localStorage.getItem('nano_api_key');
            if (!apiKey) { openSettings(); return; }

            let currentApiUrl = localStorage.getItem('nano_api_url') || DEFAULT_API_URL;
            currentApiUrl = currentApiUrl.replace(/\/+$/, "");
            if (!currentApiUrl.endsWith('/v1/images/edits')) {
                currentApiUrl += '/v1/images/edits';
            }

            const prompt = document.getElementById('prompt-input').value.trim();
            const ratio = document.getElementById('ratio-select').value; const size = document.getElementById('size-select').value; const modelName = document.getElementById('model-input').value;
            const btn = document.getElementById('generate-btn'), icon = document.getElementById('loading-icon');
            if (!prompt) { alert("请输入提示词"); return; }
            
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed'); icon.classList.remove('hidden'); 
            btn.querySelector('span').innerText = `生成中 (0/${batchSize})...`; // 显示进度

            const validImages = imageSlots.filter(item => item !== null); originalRefImage = null;
            if (validImages.length > 0) { const reader = new FileReader(); reader.onload = (e) => { originalRefImage = e.target.result; }; reader.readAsDataURL(validImages[0]); }
            const startTime = Date.now();

            // 定义单个请求函数
            const sendRequest = async () => {
                const formData = new FormData();
                formData.append('model', modelName); formData.append('prompt', prompt); 
                formData.append('aspect_ratio', ratio); formData.append('image_size', size); 
                formData.append('n', 1); // 强制每次只请求1张，通过并发实现多张
                formData.append('response_format', 'url');
                validImages.forEach((file) => formData.append('image', file));

                const response = await fetch(currentApiUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${apiKey}` }, body: formData });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || "请求失败");
                return data.data || (data.url ? [{url: data.url}] : []);
            };

            try {
                // 并发发送请求
                const requestPromises = Array.from({ length: batchSize }, () => sendRequest());
                const outcomes = await Promise.allSettled(requestPromises);
                
                const allResults = [];
                outcomes.forEach(outcome => {
                    if (outcome.status === 'fulfilled') {
                        allResults.push(...outcome.value);
                    } else {
                        console.error("部分请求失败:", outcome.reason);
                    }
                });

                const duration = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
                
                if (allResults.length > 0) { 
                    setMainImage(allResults[0].url, duration, originalRefImage); 
                    allResults.forEach(img => addToHistory(img.url, prompt, duration)); 
                } else { 
                    alert("生成失败，请检查设置或重试"); 
                }
            } catch (err) { console.error(err); alert("错误: " + err.message); } 
            finally { 
                btn.disabled = false; 
                btn.classList.remove('opacity-70', 'cursor-not-allowed'); 
                icon.classList.add('hidden'); 
                btn.querySelector('span').innerText = "✨ 立即生成"; 
            }
        }

        function setMainImage(url, duration = "", refSrc = null) {
            currentMainImageUrl = url;
            const placeholder = document.getElementById('empty-placeholder'); const timeBadge = document.getElementById('time-badge');
            placeholder.classList.add('hidden'); imgWrapper.classList.remove('hidden'); document.getElementById('main-image').src = url;
            if (refSrc) { document.getElementById('ref-image').src = refSrc; compareOverlay.classList.remove('hidden'); sliderHandle.classList.remove('hidden'); sliderHandle.style.left = '50%'; compareOverlay.style.clipPath = 'inset(0 50% 0 0)'; } 
            else { compareOverlay.classList.add('hidden'); sliderHandle.classList.add('hidden'); }
            resetZoom(); if(duration) { document.getElementById('time-val').innerText = duration; timeBadge.classList.remove('hidden'); } else { timeBadge.classList.add('hidden'); }
        }
        function clearMainPreview() { currentMainImageUrl = ""; imgWrapper.classList.add('hidden'); document.getElementById('empty-placeholder').classList.remove('hidden'); document.getElementById('time-badge').classList.add('hidden'); }
        
        function addToHistory(url, prompt, duration) {
            historyData.unshift({ url: url, prompt: prompt, duration: duration });
            saveHistoryToLocal();
            renderHistoryItem(url, prompt, duration);
        }

        function renderHistoryItem(url, prompt, duration) {
            const list = document.getElementById('history-list');
            const empty = document.getElementById('history-empty'); if (empty) empty.remove();
            const item = document.createElement('div');
            item.className = "history-item group relative flex-shrink-0 aspect-[4/3] h-full w-auto bg-gray-900 rounded-xl overflow-hidden border border-gray-700 cursor-pointer hover:border-purple-500 transition shadow-lg";
            item.dataset.url = url; item.dataset.prompt = encodeURIComponent(prompt); item.dataset.duration = duration;
            item.onclick = (e) => { if(!e.target.closest('.task-checkbox') && !e.target.closest('button')) { const decPrompt = decodeURIComponent(item.dataset.prompt); setMainImage(url, duration); document.getElementById('prompt-input').value = decPrompt; } };
            item.innerHTML = `
                <img src="${url}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-300 pointer-events-none">
                <div class="absolute top-0 left-0 right-0 h-12 bg-gradient-to-b from-black/60 to-transparent pointer-events-none"></div>
                <div class="absolute top-2 left-2 z-20">
                    <input type="checkbox" class="task-checkbox" onchange="updateBatchState()" onclick="event.stopPropagation()">
                </div>
                <div class="absolute top-2 right-2 flex gap-3 opacity-0 group-hover:opacity-100 transition duration-200 z-20">
                    <button onclick="event.stopPropagation(); downloadSingleImage('${url}')" class="w-6 h-6 rounded-full bg-black/40 hover:bg-purple-500 text-white flex items-center justify-center backdrop-blur border border-white/10 transition" title="下载">
                        <i class="fa-solid fa-download text-[10px]"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteHistoryItem(this)" class="w-6 h-6 rounded-full bg-black/40 hover:bg-red-500 text-white flex items-center justify-center backdrop-blur border border-white/10 transition" title="删除">
                        <i class="fa-solid fa-trash text-[10px]"></i>
                    </button>
                </div>
                <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/90 via-black/50 to-transparent pointer-events-none">
                    <p class="text-white text-xs font-bold line-clamp-2 leading-tight drop-shadow-md mb-1.5">${prompt.replace(/</g, "&lt;")}</p>
                    <div class="flex items-center gap-2">
                        <i class="fa-regular fa-circle-check text-green-400 text-[10px]"></i>
                        <span class="text-[9px] text-gray-500 ml-auto bg-white/10 px-1.5 py-0.5 rounded">${duration}</span>
                    </div>
                </div>`;
            list.prepend(item);
        }

        function toggleSelectAll() { const mainCb = document.getElementById('select-all'); document.querySelectorAll('#history-list .task-checkbox').forEach(cb => cb.checked = mainCb.checked); updateBatchState(); }
        
        function updateBatchState() {
            const checkboxes = document.querySelectorAll('#history-list .task-checkbox');
            const checked = Array.from(checkboxes).filter(cb => cb.checked);
            const batchActions = document.getElementById('batch-actions'); 
            const titleLabel = document.getElementById('task-list-title');

            if(checked.length > 0) {
                batchActions.classList.remove('hidden');
                titleLabel.innerHTML = `已选 <span class="text-purple-500">${checked.length}</span> 项`;
                titleLabel.classList.add('text-gray-900', 'dark:text-white');
            } else {
                batchActions.classList.add('hidden');
                titleLabel.innerHTML = '任务列表';
                titleLabel.classList.remove('text-gray-900', 'dark:text-white');
            }

            const mainCb = document.getElementById('select-all');
            if(checked.length === checkboxes.length && checkboxes.length > 0) mainCb.checked = true; else if(checked.length === 0) mainCb.checked = false; else mainCb.indeterminate = true;
        }

        async function batchDownload() {
            const checked = document.querySelectorAll('#history-list .task-checkbox:checked');
            if(checked.length === 0) return;
            if(!confirm(`确认下载选中的 ${checked.length} 张图片吗？`)) return;
            for(let cb of checked) { const item = cb.closest('.history-item'); downloadSingleImage(item.dataset.url); await new Promise(r => setTimeout(r, 500)); }
        }

        function batchDelete() {
            const checked = document.querySelectorAll('#history-list .task-checkbox:checked');
            if(checked.length === 0) return;
            if(!confirm(`确认删除选中的 ${checked.length} 张任务吗？`)) return;
            checked.forEach(cb => {
                const item = cb.closest('.history-item');
                const urlToRemove = item.dataset.url;
                historyData = historyData.filter(d => d.url !== urlToRemove);
                item.remove();
            });
            saveHistoryToLocal();
            updateBatchState();
            if(document.getElementById('history-list').children.length === 0) document.getElementById('history-list').innerHTML = '<div id="history-empty" class="text-xs text-gray-400 w-full text-center select-none">暂无历史任务</div>';
        }

        function viewOriginal(src) { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox-modal').classList.remove('hidden'); }
        function closeLightbox() { document.getElementById('lightbox-modal').classList.add('hidden'); }
        async function downloadSingleImage(url) { try { const r = await fetch(url); const b = await r.blob(); const u = window.URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `nano_${Date.now()}.jpg`; document.body.appendChild(a); a.click(); document.body.removeChild(a); window.URL.revokeObjectURL(u); } catch (e) { window.open(url, '_blank'); } }
        
        function deleteHistoryItem(btn) { 
            const item = btn.closest('.history-item');
            if(item) { 
                const urlToRemove = item.dataset.url;
                historyData = historyData.filter(d => d.url !== urlToRemove);
                saveHistoryToLocal();
                item.remove(); 
                updateBatchState(); 
                if(document.getElementById('history-list').children.length === 0) document.getElementById('history-list').innerHTML = '<div id="history-empty" class="text-xs text-gray-400 w-full text-center select-none">暂无历史任务</div>';
            } 
        }
        
        async function downloadCurrentImage() { if (!currentMainImageUrl) { alert("当前没有图片"); return; } downloadSingleImage(currentMainImageUrl); }
        async function importCurrentImage() {
            if(!currentMainImageUrl) { alert("当前没有可导入的图片"); return; }
            const emptyIndex = imageSlots.findIndex(slot => slot === null);
            if (emptyIndex === -1) { alert("格子已满 (9张)，请先删除一些图片"); return; }
            try { const r = await fetch(currentMainImageUrl); const b = await r.blob(); const f = new File([b], `import_${Date.now()}.jpg`, { type: b.type }); imageSlots[emptyIndex] = f; renderSlots(); } catch(e) { alert("导入失败"); }
        }
    </script>
</body>
</html>
